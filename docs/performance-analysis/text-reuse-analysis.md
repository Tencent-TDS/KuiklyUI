# Text ç»„ä»¶å¤ç”¨æ€§èƒ½åˆ†æ

> åˆ†ææ—¥æœŸï¼š2026-01-23  
> åˆ†æ”¯ï¼šfeature/test-lazy-reuse-issue

## æµ‹è¯•åœºæ™¯

- é¡µé¢ç»“æ„ï¼š`LazyColumn` â†’ `Row` â†’ `RankingItemView2` â†’ `Text`
- æ¯è¡Œ 5 ä¸ª itemï¼Œæ¯ä¸ª item 5 ä¸ª Text ç»„ä»¶

---

## æ ¸å¿ƒç»“è®º

### âœ… ç»“è®º 1ï¼šé¦–å±æ— é‡å¤é‡ç»„

æ¯ä¸ª Text ç»„ä»¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸåªæ‰§è¡Œ 1 æ¬¡ï¼Œæ— é‡å¤é‡ç»„ã€æµ‹é‡ã€å¸ƒå±€ã€‚

### âŒ ç»“è®º 2ï¼šåµŒå¥— LazyRow å¯¼è‡´æ— æ³•å¤ç”¨

**é—®é¢˜**ï¼š`LazyColumn` + `LazyRow` åµŒå¥—æ—¶ï¼ŒText çš„ LayoutNode æ— æ³•å¤ç”¨ã€‚

**åŸå› **ï¼šæ¯ä¸ª LazyRow æœ‰ç‹¬ç«‹çš„å¤ç”¨æ± ï¼Œå¤–å±‚è¡Œæ»šå‡ºæ—¶æ•´ä¸ªå¤ç”¨æ± è¢«ä¸¢å¼ƒã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†å†…å±‚ `LazyRow` æ”¹ä¸ºæ™®é€š `Row`ã€‚

### âŒ ç»“è®º 3ï¼šåŠ¨æ€ contentType å¯¼è‡´æ— æ³•å¤ç”¨

**é—®é¢˜**ï¼šä½¿ç”¨åŠ¨æ€å€¼ä½œä¸º `contentType`ï¼ˆå¦‚ `"${item.type}"`ï¼‰ä¼šå¯¼è‡´å¤ç”¨å¤±æ•ˆã€‚

**åŸå› **ï¼šå¤ç”¨æ± æŒ‰ `contentType` åˆ†ç»„ï¼ŒåŠ¨æ€å€¼å¯¼è‡´æ¯ä¸ª item çš„ contentType éƒ½ä¸åŒï¼Œæ— æ³•åŒ¹é…å¤ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å›ºå®šçš„ `contentType` å€¼ï¼ˆå¦‚ `"RankingItem"`ï¼‰ã€‚

### âš ï¸ ç»“è®º 4ï¼šå¿«æ»‘åŠ¨å¤ç”¨ç‡ä½

| åœºæ™¯ | å¤ç”¨ç‡ |
|------|--------|
| æ…¢æ»‘åŠ¨ | **100%** |
| å¿«æ»‘åŠ¨ | **8.7%** |

**æ ¹æœ¬åŸå› **ï¼š**æ—¶åºé—®é¢˜**

```
measure é˜¶æ®µ:  subcompose(æ–° item) â†’ éœ€è¦ slot â†’ æ—§ slot è¿˜æ²¡é‡Šæ”¾ â†’ æ— æ³•å¤ç”¨
placeChildren: disposeOrReuseStartingFromIndex() â†’ é‡Šæ”¾æ—§ slot â†’ å¤ªæ™šäº†ï¼
```

å¿«æ»‘åŠ¨æ—¶ä¸€æ¬¡ measure éœ€è¦å¤§é‡æ–° slotï¼Œä½†æ—§ slot è¦ç­‰åˆ° placeChildren é˜¶æ®µæ‰é‡Šæ”¾ï¼Œå¯¼è‡´æ— æ³•å¤ç”¨ã€‚

### âš ï¸ ç»“è®º 5ï¼šå¤§å—æ»‘åŠ¨çš„ç¬æ—¶éœ€æ±‚çˆ†å‘é—®é¢˜

**é—®é¢˜**ï¼šå¤ç”¨æ± æœºåˆ¶æœ¬èº«å¯ä»¥ç»´æŒå¹³è¡¡ï¼Œä½†**å¤§å—æ»‘åŠ¨é‚£ä¸€æ¬¡**ä¼šå¯¼è‡´ç¬æ—¶éœ€æ±‚çˆ†å‘ã€‚

**åŠ¨æ€å¹³è¡¡æ¨¡å‹**ï¼š

```
æ­£å¸¸æ»‘åŠ¨ï¼ˆå¯ç»´æŒå¹³è¡¡ï¼‰:
  ç¬¬ N å¸§: measure å– 1 ä¸ª â†’ placeChildren æ”¾ 1 ä¸ª â†’ æ± ç»´æŒå¹³è¡¡
  ç¬¬ N+1 å¸§: æœ¬å¸§é‡Šæ”¾çš„ slot â†’ è¢«ä¸‹ä¸€å¸§å¤ç”¨ â†’ å¾ªç¯å¹³è¡¡ âœ“

å¤§å—æ»‘åŠ¨ï¼ˆé—®é¢˜å¸§ï¼‰:
  - measure æ–° row Ã— 5 â†’ éœ€è¦ 5 ä¸ª slot â†’ æ± åªæœ‰ 2 ä¸ª
    â†’ å¤ç”¨ 2 ä¸ª âœ“
    â†’ æ–°å»º 3 ä¸ª âœ— ï¼ˆå¯¼è‡´ç™½å±/å¡é¡¿ï¼‰
  - placeChildren â†’ ä¸€æ¬¡æ€§é‡Šæ”¾ 5 ä¸ªæ—§ slot å…¥æ± 

å¤§å—æ»‘åŠ¨åï¼ˆæ¢å¤æ­£å¸¸ï¼‰:
  - æ± é‡Œå·²æœ‰ 5 ä¸ª slot â†’ åç»­æ»‘åŠ¨å¯æ­£å¸¸å¤ç”¨ âœ“
```

**æ ¸å¿ƒé—®é¢˜**ï¼š

| åœºæ™¯ | ç¬æ—¶éœ€æ±‚ | æ± å®¹é‡ | ç»“æœ |
|------|----------|--------|------|
| æ­£å¸¸æ»‘åŠ¨ | 1~2 ä¸ª | 1~2 ä¸ª | âœ… å¹³è¡¡å¤ç”¨ |
| **å¤§å—æ»‘åŠ¨** | 5+ ä¸ª | 1~2 ä¸ª | âŒ **æ–°å»ºå¯¼è‡´å¡é¡¿/ç™½å±** |
| å¤§å—æ»‘åŠ¨å | 1~2 ä¸ª | 5+ ä¸ª | âœ… æ± å……è¶³ï¼Œæ­£å¸¸å¤ç”¨ |

**ç»“è®º**ï¼šå¤ç”¨æ± æ˜¯"è·¨å¸§å¹³è¡¡"çš„ç³»ç»Ÿï¼Œæœ¬å¸§é‡Šæ”¾çš„ slot åªèƒ½è¢«ä¸‹ä¸€å¸§å¤ç”¨ã€‚å¤§å—æ»‘åŠ¨æ—¶ç¬æ—¶éœ€æ±‚ > æ± å®¹é‡ï¼Œå¿…é¡»æ–°å»º slotï¼Œè¿™æ˜¯å¡é¡¿çš„æ ¹æœ¬åŸå› ã€‚

---

## ä¼˜åŒ–æ–¹å‘

| ä¼˜åŒ–æ–¹å‘ | å¯è¡Œæ€§ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|--------|--------|------|
| **1. æ”¯æŒ Lazy ç»„ä»¶å¤ç”¨** | âœ… é«˜ | P0 | å¾…éªŒè¯ |
| **2. æ”¯æŒé¢„åŠ è½½ï¼ˆPrefetchï¼‰** | âœ… é«˜ | P0 | å¾…å®ç° |
| **3. é¢„é‡Šæ”¾ slot** | âš ï¸ ä¸­ | P2 | ç†è®ºå¯è¡Œï¼Œå¤æ‚åº¦é«˜ |
| **4. é¢„çƒ­å¤ç”¨æ± ** | âš ï¸ ä½ | P3 | æ”¶ç›Šä¸ç¡®å®š |

---

## ä¼˜åŒ–æ–¹å‘æ·±åº¦è®¨è®º

### ğŸ”¥ ä¼˜åŒ–æ–¹å‘ 1ï¼šæ”¯æŒ Lazy ç»„ä»¶å¤ç”¨ï¼ˆP0ï¼‰

**çŠ¶æ€**ï¼šå¾…éªŒè¯

**å¯è¡Œæ€§åˆ†æ**ï¼š

ä»ä»£ç åˆ†æï¼Œå½“ LazyRow è¢«å¤–å±‚ LazyColumn å¤ç”¨æ—¶ï¼š
- LazyRow çš„ `ReusableComposition` è¢«ä¿ç•™
- LazyRow çš„ `SubcomposeLayoutState` è¢«ä¿ç•™  
- **LazyRow å†…éƒ¨çš„å¤ç”¨æ± ä¹Ÿè¢«ä¿ç•™**
- å†…éƒ¨ Text èŠ‚ç‚¹å¯ä»¥è¢«å¤ç”¨

**å®ç°æ€è·¯**ï¼š
- ç¡®ä¿ LazyRow/LazyColumn ä½¿ç”¨ `ReusableComposeNode` è€Œé `ComposeNode`
- è®¾ç½®åˆé€‚çš„ `contentType` è®©å¤–å±‚æ­£ç¡®å¤ç”¨

**å¾…éªŒè¯ç‚¹**ï¼š
- [ ] å®é™…è¿è¡Œæ—¶å¤ç”¨é“¾è·¯æ˜¯å¦ç•…é€š
- [ ] å¤ç”¨åå†…éƒ¨çŠ¶æ€æ˜¯å¦æ­£ç¡®
- [ ] æ»šåŠ¨ä½ç½®æ˜¯å¦éœ€è¦é‡ç½®

---

### ğŸ”¥ ä¼˜åŒ–æ–¹å‘ 2ï¼šæ”¯æŒé¢„åŠ è½½ Prefetchï¼ˆP0ï¼‰

**çŠ¶æ€**ï¼šå¾…å®ç°

**åŸç†**ï¼šæå‰ `precompose` å³å°†å¯è§çš„ itemï¼Œè¿™æ ·åœ¨æ»šåŠ¨åˆ°è¯¥ä½ç½®æ—¶ï¼Œslot å·²ç»å‡†å¤‡å¥½äº†ã€‚

**å…³é”® API**ï¼ˆSubcomposeLayout.ktï¼‰ï¼š

```kotlin
fun precompose(
    slotId: Any?,
    content: @Composable () -> Unit,
): PrecomposedSlotHandle {
    // ...
    val node = precomposeMap.getOrPut(slotId) {
        val reusedNode = takeNodeFromReusables(slotId)
        if (reusedNode != null) {
            // å¤ç”¨å·²æœ‰ slot
        } else {
            createNodeAt(root.foldedChildren.size).also {
                precomposedCount++
            }
        }
    }
    subcompose(node, slotId, content)
    // ...
}
```

**æ•ˆæœ**ï¼š
- é¦–æ¬¡æ»‘åŠ¨ä¸å®¹æ˜“ç™½å±ï¼Œå› ä¸º slot å·²ç»é¢„åˆ›å»ºå¥½äº†
- é¢„åŠ è½½çš„ item åœ¨ `precomposeMap` ä¸­ç­‰å¾…ä½¿ç”¨

**å®ç°æ–¹å¼**ï¼š
- åˆ©ç”¨ `SubcomposeLayoutState.precompose()` API
- åœ¨æ»šåŠ¨ç›‘å¬ä¸­ï¼Œæå‰ precompose ä¸‹ N ä¸ª item

**ä¼˜åŠ¿**ï¼š
- API å·²å­˜åœ¨ï¼Œå®ç°ç›¸å¯¹ç®€å•
- ç›´æ¥è§£å†³ã€Œé¦–æ¬¡æ»‘åŠ¨ç™½å±ã€é—®é¢˜

---

### âš ï¸ ä¼˜åŒ–æ–¹å‘ 3ï¼šé¢„é‡Šæ”¾ slotï¼ˆP2ï¼‰

**çŠ¶æ€**ï¼šç†è®ºå¯è¡Œï¼Œå¤æ‚åº¦é«˜

**æƒ³æ³•**ï¼šåœ¨ measure é˜¶æ®µå¼€å§‹æ—¶ï¼Œå…ˆæŠŠç¡®å®šè¦æ»‘å‡ºçš„æ—§ slot é‡Šæ”¾åˆ°å¤ç”¨æ± 

**é—®é¢˜åˆ†æ**ï¼š

```
å½“å‰æµç¨‹ï¼š
  measure å¼€å§‹ â†’ subcompose(æ–° item) â†’ éœ€è¦ slot â†’ æ± ä¸ºç©º â†’ æ–°å»º
                                                    â†‘
                                                    æ—§ slot è¿˜æ²¡é‡Šæ”¾ï¼
  placeChildren â†’ disposeOrReuseStartingFromIndex() â†’ é‡Šæ”¾æ—§ slot â†’ å¤ªæ™šäº†
```

**å›°éš¾ç‚¹**ï¼š
- åœ¨ measure å¼€å§‹æ—¶ï¼Œ**è¿˜ä¸çŸ¥é“å“ªäº› slot ä¼šè¢«éœ€è¦**
- å¿…é¡»ç­‰ measure è®¡ç®—å®Œå¯è§åŒºåŸŸåï¼Œæ‰èƒ½ç¡®å®šæ–° slot åˆ—è¡¨
- è¿™æ˜¯ä¸ªã€Œé¸¡ç”Ÿè›‹ã€é—®é¢˜

**å¯èƒ½çš„æ”¹è¿›**ï¼š
- åŸºäº**æ»šåŠ¨æ–¹å‘ + æ»šåŠ¨è·ç¦»**ï¼Œ**é¢„æµ‹**å“ªäº› slot ä¼šæ»‘å‡º
- åœ¨ measure å¼€å§‹å‰ï¼Œå…ˆé‡Šæ”¾é¢„æµ‹è¦æ»‘å‡ºçš„ slot
- é£é™©ï¼šé¢„æµ‹é”™è¯¯ä¼šå¯¼è‡´é¢å¤–çš„åˆ›å»º/é”€æ¯å¼€é”€

**ç»“è®º**ï¼šå®ç°å¤æ‚åº¦é«˜ï¼Œä¸å¦‚å…ˆéªŒè¯ã€Œæ”¯æŒ Lazy å¤ç”¨ã€å’Œã€Œé¢„åŠ è½½ã€è¿™ä¸¤ä¸ªæ›´é è°±çš„æ–¹æ¡ˆã€‚

---

### âš ï¸ ä¼˜åŒ–æ–¹å‘ 4ï¼šé¢„çƒ­å¤ç”¨æ± ï¼ˆP3ï¼‰

**çŠ¶æ€**ï¼šæ”¶ç›Šä¸ç¡®å®š

**æƒ³æ³•**ï¼šåˆå§‹åŒ–æ—¶é¢„åˆ›å»ºä¸€äº› slot æ”¾å…¥æ± ä¸­

**é—®é¢˜åˆ†æ**ï¼š
- é¢„åˆ›å»ºçš„ slot æ²¡æœ‰çœŸå®å†…å®¹ï¼Œæ— æ³•å¤ç”¨
- å¤ç”¨è¦æ±‚ `contentType` åŒ¹é…ï¼Œé¢„åˆ›å»ºçš„ç©º slot å¯èƒ½ä¸åŒ¹é…
- å¢åŠ å¯åŠ¨æ—¶é—´å’Œå†…å­˜å ç”¨

**å¯èƒ½çš„æ”¹è¿›**ï¼š
- é¢„åˆ›å»ºæ—¶ä½¿ç”¨å ä½ content
- ä½†è¿™æ ·å¢åŠ äº†å¤æ‚åº¦ï¼Œæ”¶ç›Šä¸æ˜ç¡®

**ç»“è®º**ï¼šæ”¶ç›Šä¸ç¡®å®šï¼Œä¼˜å…ˆçº§æœ€ä½ã€‚

---

### ğŸ¤” è®¨è®ºï¼šè®© Lazy ç»„ä»¶æ”¯æŒå¤ç”¨ï¼Œèƒ½å¦è§£å†³åµŒå¥—é—®é¢˜ï¼Ÿ

### ğŸ¤” è®¨è®ºï¼šè®© Lazy ç»„ä»¶æ”¯æŒå¤ç”¨ï¼Œèƒ½å¦è§£å†³åµŒå¥—é—®é¢˜ï¼Ÿ

#### å½“å‰åµŒå¥—é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼ˆä¿®æ­£å‰çš„ç†è§£ï¼‰

```
LazyColumn (å¤–å±‚)
    â””â”€â”€ slot[row-0] â†’ LazyRow (å†…å±‚) â† æœ‰è‡ªå·±ç‹¬ç«‹çš„ SubcomposeLayoutState
                         â””â”€â”€ slot[item-0] 
                         â””â”€â”€ slot[item-1]
                         â””â”€â”€ reusablePool (å†…å±‚å¤ç”¨æ± )
    â””â”€â”€ slot[row-1] â†’ LazyRow (å†…å±‚) â† å¦ä¸€ä¸ªç‹¬ç«‹çš„ SubcomposeLayoutState
                         â””â”€â”€ slot[item-0]
                         â””â”€â”€ reusablePool (å†…å±‚å¤ç”¨æ± ) â† ä¸åŒ LazyRow å®ä¾‹çš„æ± å­ä¸å…±äº«ï¼
```

#### ğŸ”„ å…³é”®å‘ç°ï¼šLazyRow è¢«å¤ç”¨æ—¶ï¼Œå†…éƒ¨ Text èŠ‚ç‚¹ä¹Ÿä¼šè¢«å¤ç”¨ï¼

**ä»£ç åˆ†æ**ï¼ˆSubcomposeLayout.ktï¼‰ï¼š

**1. ä»å¤ç”¨æ± å–å‡ºæ—¶ (`takeNodeFromReusables`)**

```kotlin
private fun takeNodeFromReusables(slotId: Any?): LayoutNode? {
    // ...
    val nodeState = nodeToNodeState[node]!!
    nodeState.forceReuse = true   // â¬…ï¸ æ ‡è®°éœ€è¦å¤ç”¨
    nodeState.forceRecompose = true
    return node
}
```

**2. å¤ç”¨æ—¶è°ƒç”¨ `setContentWithReuse`**

```kotlin
private fun subcomposeInto(...): ReusableComposition =
    if (existing == null || existing.isDisposed) {
        createSubcomposition(container, parent)  // æ–°å»º
    } else {
        existing  // â¬…ï¸ å¤ç”¨å·²æœ‰çš„ ReusableCompositionï¼
    }.apply {
        if (!reuseContent) {
            setContent(composable)
        } else {
            setContentWithReuse(composable)  // â¬…ï¸ å¸¦å¤ç”¨åœ°è®¾ç½®å†…å®¹ï¼
        }
    }
```

**å¤ç”¨é“¾è·¯**ï¼š

```
LazyRow è¢«å¤ç”¨
    â†“
LazyRow çš„ composition è¢«ä¿ç•™ï¼ˆexisting != nullï¼‰
    â†“
è°ƒç”¨ setContentWithReuse(composable)
    â†“
LazyRow å†…éƒ¨çš„ SubcomposeLayoutState ä¹Ÿè¢«ä¿ç•™
    â†“
LazyRow å†…éƒ¨çš„å¤ç”¨æ± ä¹Ÿè¢«ä¿ç•™ï¼
    â†“
Text èŠ‚ç‚¹å¯ä»¥è¢«å¤ç”¨ âœ“
```

#### âœ… ä¿®æ­£åçš„ç»“è®ºï¼šè®© LazyRow æ”¯æŒå¤ç”¨**å¯ä»¥è§£å†³**åµŒå¥—é—®é¢˜ï¼

| çŠ¶æ€ | æ˜¯å¦ä¿ç•™ |
|------|----------|
| LazyRow çš„ `ReusableComposition` | âœ… ä¿ç•™ |
| LazyRow çš„ `SubcomposeLayoutState` | âœ… ä¿ç•™ |
| LazyRow å†…éƒ¨çš„å¤ç”¨æ±  | âœ… ä¿ç•™ |
| LazyRow å†…éƒ¨çš„ Text èŠ‚ç‚¹ | âœ… å¯å¤ç”¨ |

**åŸç†**ï¼š
1. LazyRow æ•´ä½“è¢«å¤ç”¨ â†’ ä¸ä¼šé”€æ¯
2. LazyRow å†…éƒ¨çš„ `SubcomposeLayoutState` ä¿ç•™ â†’ å¤ç”¨æ± ä¿ç•™
3. LazyRow å†…éƒ¨æ»‘åŠ¨æ—¶ â†’ å¯ä»¥æ­£å¸¸ä»è‡ªå·±çš„å¤ç”¨æ± å–/æ”¾èŠ‚ç‚¹
4. Text èŠ‚ç‚¹åœ¨ LazyRow å†…éƒ¨å°±èƒ½å®Œæˆå¤ç”¨ â†’ **ä¸éœ€è¦è·¨å®ä¾‹å¤ç”¨ï¼**

#### âš ï¸ ä»éœ€æ³¨æ„çš„é—®é¢˜

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| **é¦–æ¬¡å¤§å—æ»‘åŠ¨** | LazyRow é¦–æ¬¡è¿›å…¥å¤ç”¨æ± å‰ï¼Œå†…éƒ¨å¤ç”¨æ± å¯èƒ½è¿˜æ²¡ç§¯ç´¯è¶³å¤Ÿçš„ slot |
| **å¤§å—æ»‘åŠ¨æ—¶åºé—®é¢˜** | å†…å±‚ LazyRow ä»ç„¶æœ‰ã€Œå…ˆå–åæ”¾ã€çš„æ—¶åºé—®é¢˜ |
| **LazyRow å†…å®¹å·®å¼‚å¤§** | å¦‚æœä¸åŒè¡Œçš„ LazyRow å†…å®¹å·®å¼‚å¾ˆå¤§ï¼Œå¤ç”¨æ•ˆæœå¯èƒ½ä¸ç†æƒ³ |

#### æœ€ç»ˆç»“è®º

> **âœ… è®© LazyRow æ”¯æŒå¤ç”¨ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³åµŒå¥— Lazy çš„å¤ç”¨é—®é¢˜ï¼**
>
> å…³é”®æ˜¯ï¼šLazyRow è¢«å¤ç”¨æ—¶ï¼Œå®ƒå†…éƒ¨çš„ `SubcomposeLayoutState` å’Œå¤ç”¨æ± éƒ½ä¼šä¿ç•™ï¼Œæ‰€ä»¥å†…éƒ¨çš„ Text èŠ‚ç‚¹ä¹Ÿèƒ½è¢«å¤ç”¨ã€‚
>
> è¿™æ¯”ã€Œå…¨å±€å…±äº«å¤ç”¨æ± ã€çš„æ–¹æ¡ˆæ›´ç®€å•å¯è¡Œã€‚

---

## è¯¦ç»†æ–‡æ¡£

- [å¿«æ»‘åŠ¨å¤ç”¨ç‡ä½çš„è¯¦ç»†ä»£ç åˆ†æ](./text-reuse-detail.md)
- æµ‹è¯•æ—¥å¿—ï¼š`demo/src/commonMain/kotlin/com/tencent/kuikly/demo/pages/jank/log1.txt`
